{% extends "baaswebapp/layout.html" %}

{% load crispy_forms_tags %}

{% block content %}
{% include "trialapp/header.html" with title=field_trial_name action=title subtitle='assessment' go_ref='field_trial_api' new_href_id='evaluation-edit' list_href='evaluation-list' refId=field_trial_id%}

{% if errors %}
<div class="alert alert-primary" role="alert">{{errors}}</div>
{% endif %}
<div class="row">
  <div class="col-md-6">
    <div class="card no-border" >
      <div class="card-body-baas">  
        {% crispy edit_form %}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card no-border">
      <div class="card-body-baas">
        {% if evaluation_id %}
            <h4>Define thesis & products to be applied:</h4>
            <table class="table"><tbody id="table-items">
            <tr id="product_evaluation">
                {% include "trialapp/evaluation_add_product.html" with evaluation_id=evaluation_id products=products %}
            </tr>
            {% for item in product_list %}
                <tr id="item-{{item.id}}">
                    <td>{{item.name}}</td>
                    <td><a id='delete-item-{{item.id}}' class="btn btn-warning btn-sm fs-4">-</a></td>
                </tr>
            {% empty %}
                <p>No applied products from thesis defined.</p>
            {% endfor %}
            
            </tbody></table>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src='/static/baaswebapp/scripts/baas.js'></script>
<script>
$('.evaluation-add-product-form').submit( function(){
    var element=$(this)
    var appendTable=$('#table-items')
    return addProductToevaluationCall(element,appendTable)
});

var manageItemEndPoint = '/manage_product_to_evaluation_api';

function addProductToevaluationCall(element,appendTable) {
    var dataJson={}
    $(element.serializeArray()).each(function(index,obj){
        dataJson[obj.name]=obj.value;
    });
    dataJson['evaluation_id']=element.attr('id');
    $.ajax({
        type : element.attr('method'), 
        url: manageItemEndPoint,
        data: dataJson,
        
        success: function(data){
            console.log("data");
            appendTable.append(
                '<tr id="product-evaluation-'+data.id+'"><td>'+data.name+'</td>\
                <td><a id="delete-product-'+data.id+'" class="btn btn-warning btn-sm fs-4">-</a></td>\
                </tr>'); /* response message */
        },
    
        failure: function() {
            alert('Error. Please reload');
        }
    });
    return false;
};


</script>
{% endblock %}